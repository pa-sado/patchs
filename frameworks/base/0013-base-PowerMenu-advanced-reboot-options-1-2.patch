From c94711ad9f8990164fc992544c1165ffba23dc38 Mon Sep 17 00:00:00 2001
From: ezio84 <brabus84@gmail.com>
Date: Sun, 18 Oct 2020 19:14:32 +0200
Subject: [PATCH 13/21] base: PowerMenu advanced reboot options [1/2]

Now R already provides an additional dialog when there are more
than the max allowed buttons in the first row (3 by default),
to put there both Power and Restart button.

We can use that existing logic to put together Restart and our
custom buttons (recovery-bootloader-systemui), without breaking
the possibility for Power to be moved there if needed.

Q reference: https://github.com/ezio84/abc_frameworks_base/commit/749ba7b9e0821d755d8775b018af266083569ffc

[jhonboy121]: adapt to A12, A13 and some improvements:
  * Override some interface methods in the class itself (which had the same implementation in all three actions)
  * Get rid of unnecessary triggerAction method, instead override onPress when creating the instances. This makes the AdvancedAction class pretty light
  * Match power options dialog layout with global actions dialog
  * use switch case for adding actions (looks nice and is probably more efficient)
  * use forEach loops and method reference in some places
  * defer from adding restart actions to tempActions list only to remove them later

Change-Id: I8273ecf9ecf2ee7e8bbdc035f33479e3dac80577

Thanks to ghostrider-reborn for spotting a derp in ShutdownThread

[rk134]: Adapt to A14 and move changes into ShutdownUI globalaction

Co-authored-by: jhonboy121 <alfredmathew05@gmail.com>
Co-authored-by: rk134 <rahul@aospa.co>
Change-Id: I42873fb0b3f1066ed53fc269bb1a6a6724757d69
Signed-off-by: jhonboy121 <alfredmathew05@gmail.com>
Signed-off-by: Adithya R <gh0strider.2k18.reborn@gmail.com>
Signed-off-by: chrisl7 <wandersonrodriguesf1@gmail.com>
Signed-off-by: Jprimero15 <jprimero15@aospa.co>
Signed-off-by: rk134 <rahul@aospa.co>
---
 core/java/android/os/PowerManager.java        |  10 +
 .../internal/statusbar/IStatusBarService.aidl |   1 +
 core/res/res/values/aospa_strings.xml         |   8 +
 core/res/res/values/aospa_symbols.xml         |   8 +
 core/res/res/values/config.xml                |   2 +-
 .../systemui/plugins/GlobalActions.java       |   1 +
 .../res/drawable/ic_restart_advanced.xml      |  35 +++
 .../res/drawable/ic_restart_bootloader.xml    |  26 ++
 .../res/drawable/ic_restart_recovery.xml      |  26 ++
 .../SystemUI/res/drawable/ic_restart_ui.xml   |  26 ++
 .../SystemUI/res/values/aospa_strings.xml     |   6 +
 .../globalactions/GlobalActionsComponent.java |   8 +
 .../GlobalActionsDialogLite.java              | 283 +++++++++++-------
 .../globalactions/GlobalActionsImpl.java      |   1 +
 .../GlobalActionsPowerDialog.java             |  74 +++--
 .../systemui/globalactions/ShutdownUi.java    |   8 +-
 .../android/server/power/ShutdownThread.java  |  25 +-
 .../statusbar/StatusBarManagerService.java    |  18 ++
 18 files changed, 429 insertions(+), 137 deletions(-)
 create mode 100644 packages/SystemUI/res/drawable/ic_restart_advanced.xml
 create mode 100644 packages/SystemUI/res/drawable/ic_restart_bootloader.xml
 create mode 100644 packages/SystemUI/res/drawable/ic_restart_recovery.xml
 create mode 100644 packages/SystemUI/res/drawable/ic_restart_ui.xml

diff --git a/core/java/android/os/PowerManager.java b/core/java/android/os/PowerManager.java
index d1c10fa46aaa..a959e7baa096 100644
--- a/core/java/android/os/PowerManager.java
+++ b/core/java/android/os/PowerManager.java
@@ -841,6 +841,16 @@ public final class PowerManager {
      */
     public static final String REBOOT_RECOVERY = "recovery";
 
+    /**
+     * The value to pass as the 'reason' argument to reboot() to reboot into
+     * bootloader mode if you need to get to the choppa (cit)
+     * <p>
+     * Requires {@link android.Manifest.permission#REBOOT}).
+     * </p>
+     * @hide
+     */
+    public static final String REBOOT_BOOTLOADER = "bootloader";
+
     /**
      * The value to pass as the 'reason' argument to reboot() to reboot into
      * recovery mode for applying system updates.
diff --git a/core/java/com/android/internal/statusbar/IStatusBarService.aidl b/core/java/com/android/internal/statusbar/IStatusBarService.aidl
index d26b14d17ad1..9baa8e72eedd 100644
--- a/core/java/com/android/internal/statusbar/IStatusBarService.aidl
+++ b/core/java/com/android/internal/statusbar/IStatusBarService.aidl
@@ -103,6 +103,7 @@ interface IStatusBarService
      */
     void shutdown();
     void reboot(boolean safeMode);
+    void advancedReboot(String mode);
 
     /** just restarts android without rebooting device. Used for some feature flags. */
     void restart();
diff --git a/core/res/res/values/aospa_strings.xml b/core/res/res/values/aospa_strings.xml
index 4af3896c4f59..9fb4e6c518a5 100644
--- a/core/res/res/values/aospa_strings.xml
+++ b/core/res/res/values/aospa_strings.xml
@@ -39,4 +39,12 @@
     <string name="pocket_mode_instruction_step1">1. Ensure the green area (proximity sensor) shown above is unobstructed and free from dirt or dust.</string>
     <string name="pocket_mode_instruction_step2">2. Press and hold the power button to exit pocket mode.</string>
 
+    <!-- Advanced reboot -->
+    <string name="reboot_to_recovery_title">Recovery</string>
+    <string name="reboot_to_recovery_message">Rebooting to recovery</string>
+    <string name="reboot_to_bootloader_title">Bootloader</string>
+    <string name="reboot_to_bootloader_message">Rebooting to bootloader</string>
+    <string name="reboot_title">Reboot</string>
+    <string name="reboot_message">Rebooting system</string>
+
 </resources>
diff --git a/core/res/res/values/aospa_symbols.xml b/core/res/res/values/aospa_symbols.xml
index 32aa429a1db5..1b05913d58cc 100644
--- a/core/res/res/values/aospa_symbols.xml
+++ b/core/res/res/values/aospa_symbols.xml
@@ -139,5 +139,13 @@
 
     <!-- Leds -->
     <java-symbol type="bool" name="config_intrusiveBatteryLed" />
+    
+    <!-- Advanced reboot -->
+    <java-symbol type="string" name="reboot_to_recovery_title" />
+    <java-symbol type="string" name="reboot_to_recovery_message" />
+    <java-symbol type="string" name="reboot_to_bootloader_title" />
+    <java-symbol type="string" name="reboot_to_bootloader_message" />
+    <java-symbol type="string" name="reboot_title" />
+    <java-symbol type="string" name="reboot_message" />
 
 </resources>
diff --git a/core/res/res/values/config.xml b/core/res/res/values/config.xml
index 99c07ddbe92f..0ffd77182050 100644
--- a/core/res/res/values/config.xml
+++ b/core/res/res/values/config.xml
@@ -3497,7 +3497,7 @@
         <item>restart</item>
         <item>logout</item>
         <item>screenshot</item>
-        <item>bugreport</item>
+        <!--<item>bugreport</item>-->
     </string-array>
 
     <!-- Number of milliseconds to hold a wake lock to ensure that drawing is fully
diff --git a/packages/SystemUI/plugin/src/com/android/systemui/plugins/GlobalActions.java b/packages/SystemUI/plugin/src/com/android/systemui/plugins/GlobalActions.java
index 95ff13b45fb9..d7dfeaeced88 100644
--- a/packages/SystemUI/plugin/src/com/android/systemui/plugins/GlobalActions.java
+++ b/packages/SystemUI/plugin/src/com/android/systemui/plugins/GlobalActions.java
@@ -41,5 +41,6 @@ public interface GlobalActions extends Plugin {
 
         void shutdown();
         void reboot(boolean safeMode);
+        void advancedReboot(String mode);
     }
 }
diff --git a/packages/SystemUI/res/drawable/ic_restart_advanced.xml b/packages/SystemUI/res/drawable/ic_restart_advanced.xml
new file mode 100644
index 000000000000..f7193d3923fe
--- /dev/null
+++ b/packages/SystemUI/res/drawable/ic_restart_advanced.xml
@@ -0,0 +1,35 @@
+<!--
+    Copyright (C) 2016 The Android Open Source Project
+    Copyright (C) 2017 The ABC rom
+
+    Licensed under the Apache License, Version 2.0 (the "License");
+    you may not use this file except in compliance with the License.
+    You may obtain a copy of the License at
+
+         http://www.apache.org/licenses/LICENSE-2.0
+
+    Unless required by applicable law or agreed to in writing, software
+    distributed under the License is distributed on an "AS IS" BASIS,
+    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+    See the License for the specific language governing permissions and
+    limitations under the License.
+-->
+<vector xmlns:android="http://schemas.android.com/apk/res/android"
+        android:width="24.0dp"
+        android:height="24.0dp"
+        android:viewportHeight="24.0"
+        android:viewportWidth="24.0"
+        android:tint="?android:attr/colorControlNormal">
+    <path
+        android:fillColor="#FF000000"
+        android:pathData="m 12,4 0,-3 0.0089,5.0067283 L 12,9 12.007813,6.0078125 C 15.907812,6.0078125 19,9.1 19,13 c 0,3.9 -3.1,7 -7,7 l 0,2 c 5,0 9,-4 9,-9 0,-5 -4,-9 -9,-9 z"/>
+    <path
+        android:fillColor="#FF000000"
+        android:pathData="M5.0,12.9C5.0,11.0 5.8,9.2 7.2,7.9L5.8,6.4C4.0,8.1 3.0,10.5 3.0,12.9c0.0,4.0 2.7,7.6 6.5,8.7l0.5,-1.9C7.1,18.8 5.0,16.1 5.0,12.9z"/>
+    <circle
+        fill="#FF000000"
+        id="path4145"
+        cx="11.844038"
+        cy="5.1732821"
+        r="2.4142135" />
+</vector>
diff --git a/packages/SystemUI/res/drawable/ic_restart_bootloader.xml b/packages/SystemUI/res/drawable/ic_restart_bootloader.xml
new file mode 100644
index 000000000000..818abc9b6f01
--- /dev/null
+++ b/packages/SystemUI/res/drawable/ic_restart_bootloader.xml
@@ -0,0 +1,26 @@
+<!--
+    Copyright (C) 2016 The Android Open Source Project
+    Copyright (C) 2017 The ABC rom
+
+    Licensed under the Apache License, Version 2.0 (the "License");
+    you may not use this file except in compliance with the License.
+    You may obtain a copy of the License at
+
+         http://www.apache.org/licenses/LICENSE-2.0
+
+    Unless required by applicable law or agreed to in writing, software
+    distributed under the License is distributed on an "AS IS" BASIS,
+    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+    See the License for the specific language governing permissions and
+    limitations under the License.
+-->
+<vector xmlns:android="http://schemas.android.com/apk/res/android"
+        android:width="24.0dp"
+        android:height="24.0dp"
+        android:viewportHeight="24.0"
+        android:viewportWidth="24.0"
+        android:tint="?android:attr/colorControlNormal">
+    <path
+        android:fillColor="#FF000000"
+        android:pathData="M 14.912943,5.0974535 14.75145,5.4873996 c -0.41358,-0.055144 -0.835037,-0.055144 -1.248616,0 L 13.341343,5.0974535 c -0.133923,-0.3229861 -0.449031,-0.531745 -0.799589,-0.531745 -0.114221,0 -0.224512,0.023634 -0.330861,0.066961 l -0.736564,0.3032908 c -0.212698,0.086654 -0.37813,0.2560256 -0.468724,0.4687235 -0.08665,0.2126965 -0.08665,0.4490285 0,0.6617252 l 0.161493,0.3899462 C 10.836235,6.7123809 10.536882,7.0077944 10.284796,7.3386576 L 9.8948495,7.1771643 c -0.106352,-0.043326 -0.216637,-0.066962 -0.330862,-0.066962 -0.3505588,0 -0.6656658,0.2087589 -0.7995869,0.5317454 l -0.3032905,0.736565 c -0.086654,0.2126979 -0.086654,0.4490286 0,0.6617265 0.086652,0.2126979 0.2560243,0.3781289 0.4687226,0.4687225 l 0.389946,0.1614936 c -0.05514,0.4175187 -0.05514,0.8350367 0,1.2486157 l -0.389946,0.161493 c -0.2126983,0.08666 -0.3781295,0.256025 -0.4687226,0.468722 -0.086654,0.212699 -0.086654,0.449029 0,0.661728 l 0.3032905,0.736564 c 0.1339211,0.322986 0.4490281,0.531744 0.7995869,0.531744 0.114223,0 0.224513,-0.02363 0.330862,-0.06696 l 0.3899465,-0.161495 c 0.256024,0.330865 0.551439,0.630217 0.882301,0.882303 l -0.161493,0.389951 c -0.181187,0.441149 0.02757,0.945324 0.468724,1.12651 l 0.736564,0.303292 c 0.106352,0.04332 0.216637,0.06696 0.330861,0.06696 0.350559,0 0.665666,-0.208759 0.799589,-0.531743 l 0.161491,-0.389946 c 0.41358,0.05513 0.835036,0.05513 1.248616,0 l 0.161493,0.389946 c 0.133921,0.322985 0.449028,0.531744 0.799586,0.531744 0.114223,0 0.224514,-0.02363 0.330863,-0.06696 l 0.736564,-0.303292 c 0.212697,-0.08665 0.378129,-0.256025 0.468724,-0.468724 0.08666,-0.212697 0.08666,-0.449027 0,-0.661726 l -0.161492,-0.389945 c 0.330861,-0.256024 0.630213,-0.551437 0.8823,-0.882302 l 0.389946,0.161493 c 0.106352,0.04332 0.216636,0.06696 0.330863,0.06696 v 0 c 0.350558,0 0.665665,-0.208758 0.799587,-0.531745 l 0.303291,-0.736563 c 0.08665,-0.212699 0.08665,-0.449029 0,-0.661728 -0.08666,-0.212696 -0.256026,-0.378128 -0.468723,-0.46872 l -0.389946,-0.161493 c 0.05513,-0.41752 0.05513,-0.835038 0,-1.2486176 l 0.389946,-0.161495 c 0.212697,-0.086663 0.378129,-0.2560234 0.468723,-0.4687213 0.08665,-0.2126979 0.08665,-0.4490298 0,-0.6617278 L 19.489883,7.63801 C 19.355961,7.3150248 19.040855,7.1062658 18.690297,7.1062658 c -0.114221,0 -0.224514,0.023637 -0.330863,0.066962 L 17.969487,7.3347211 C 17.713464,7.0038578 17.418048,6.7045055 17.087187,6.4524187 l 0.161491,-0.3899461 c 0.08666,-0.2126979 0.08666,-0.4490286 0,-0.6617264 C 17.162028,5.1880496 16.992652,5.0226173 16.779955,4.9320239 L 16.043391,4.6287301 c -0.106352,-0.043328 -0.216636,-0.06696 -0.330863,-0.06696 -0.350557,0 -0.665665,0.2087589 -0.799585,0.5356834 z m 0.44115,0.9728947 0.279659,-0.6774812 c 0.01575,-0.03939 0.05121,-0.051209 0.07878,-0.051209 0.01178,0 0.01968,0.00397 0.03153,0.00781 l 0.736565,0.3032914 c 0.02757,0.011794 0.03938,0.031507 0.04332,0.043326 0.0078,0.015754 0.01179,0.03939 0,0.063027 l -0.279665,0.677485 c -0.07091,0.173309 -0.01179,0.3702521 0.141798,0.4726614 0.445088,0.2993525 0.82322,0.6735436 1.118634,1.1186333 0.102404,0.1536152 0.303291,0.2166368 0.47266,0.1457372 l 0.677483,-0.2796587 c 0.01179,-0.00397 0.01969,-0.00781 0.03153,-0.00781 0.02757,0 0.06301,0.011794 0.07878,0.051209 l 0.303292,0.736564 c 0.01575,0.043326 -0.0038,0.090598 -0.04332,0.1102873 l -0.67749,0.2796586 c -0.173308,0.070909 -0.267841,0.2520855 -0.232391,0.4372116 0.106352,0.5238679 0.102406,1.0556139 0,1.5834179 -0.03544,0.181189 0.06302,0.366313 0.232391,0.437213 l 0.677484,0.279659 c 0.02757,0.01178 0.03939,0.03153 0.04332,0.04332 0.0078,0.01575 0.01179,0.03938 0,0.06301 l -0.303305,0.736569 c -0.01575,0.03938 -0.05121,0.05121 -0.07878,0.05121 -0.01178,0 -0.0197,-0.0038 -0.03153,-0.0078 l -0.677479,-0.279659 c -0.17331,-0.0709 -0.370252,-0.01179 -0.472662,0.141798 -0.299351,0.445089 -0.673544,0.82322 -1.118636,1.118634 -0.153613,0.102405 -0.216636,0.303289 -0.145736,0.472661 l 0.279657,0.677482 c 0.01178,0.02757 0.0078,0.05121 0,0.06302 -0.0078,0.01575 -0.01968,0.03544 -0.04727,0.04332 l -0.736566,0.303292 c -0.01178,0.0038 -0.01968,0.0078 -0.03153,0.0078 -0.02757,0 -0.06301,-0.01178 -0.07878,-0.05121 L 15.346194,14.50735 c -0.06301,-0.149677 -0.204821,-0.240271 -0.358435,-0.240271 -0.02364,0 -0.05121,0.0038 -0.07484,0.0078 -0.519928,0.102405 -1.05955,0.102405 -1.583417,0 -0.181187,-0.03545 -0.366313,0.06301 -0.437213,0.232391 l -0.279658,0.677488 c -0.01575,0.03939 -0.05121,0.05121 -0.07878,0.05121 -0.01179,0 -0.01968,-0.0038 -0.03153,-0.0078 l -0.736554,-0.303303 c -0.04332,-0.01575 -0.06302,-0.06696 -0.04332,-0.110287 l 0.27966,-0.677483 c 0.07089,-0.173307 0.01179,-0.370251 -0.1418,-0.472662 -0.445088,-0.299352 -0.823219,-0.673541 -1.118631,-1.118633 -0.102405,-0.153614 -0.303294,-0.216636 -0.472662,-0.145737 l -0.6774815,0.279659 c -0.0118,0.0038 -0.01968,0.0078 -0.03151,0.0078 -0.02757,0 -0.06302,-0.01179 -0.07878,-0.05121 l -0.303289,-0.736554 c -0.0118,-0.02757 -0.0078,-0.05121 0,-0.06301 0.0079,-0.01575 0.01968,-0.03544 0.04332,-0.04332 l 0.677481,-0.279658 c 0.1733085,-0.0709 0.2678415,-0.252086 0.2323925,-0.437211 -0.106354,-0.523868 -0.102416,-1.055612 0,-1.583418 0.03544,-0.181192 -0.06301,-0.3663169 -0.2323925,-0.4372166 L 9.2213097,8.7763407 c -0.02757,-0.011794 -0.03939,-0.031507 -0.04332,-0.043326 -0.0078,-0.015754 -0.01179,-0.039377 0,-0.063014 l 0.303291,-0.7365653 c 0.01575,-0.03939 0.0512,-0.051196 0.07878,-0.051196 0.0118,0 0.01969,0.00397 0.03151,0.00781 l 0.6774823,0.2796587 c 0.173311,0.070903 0.370254,0.011799 0.472664,-0.1417957 C 11.041069,7.5828215 11.41526,7.2046926 11.86035,6.9092791 12.013966,6.8068744 12.076986,6.6059878 12.006087,6.4366177 L 11.726414,5.7591788 c -0.01179,-0.027572 -0.0078,-0.051209 0,-0.063026 0.0078,-0.015754 0.01968,-0.035442 0.04727,-0.047261 l 0.736558,-0.3032913 c 0.01179,-0.00397 0.01968,-0.00781 0.03153,-0.00781 0.02757,0 0.06302,0.011794 0.07877,0.051209 l 0.279657,0.6774826 c 0.07089,0.1733089 0.256025,0.2678415 0.437213,0.2323916 0.519926,-0.1024172 1.059549,-0.1024172 1.583415,0 0.17725,0.039391 0.362375,-0.055144 0.433275,-0.228454 z m -2.189999,1.9024641 c -0.618399,0.2560245 -1.102877,0.7405031 -1.358903,1.3589017 -0.256025,0.6184005 -0.256025,1.30376 0,1.922161 0.389947,0.941383 1.29982,1.551906 2.319982,1.551906 0.330863,0 0.653848,-0.06301 0.961078,-0.193006 0.618399,-0.256025 1.102878,-0.740503 1.358901,-1.3589 0.256026,-0.618401 0.256026,-1.3037605 0,-1.922161 -0.389944,-0.9413839 -1.299818,-1.5519058 -2.319979,-1.5519058 -0.330864,0 -0.653851,0.066961 -0.961079,0.1930041 z m 2.560252,1.6582542 c 0.177247,0.4293365 0.177247,0.8980575 0,1.3273935 -0.177249,0.429335 -0.508112,0.760198 -0.937447,0.937446 -0.212698,0.08666 -0.433273,0.13392 -0.661726,0.13392 -0.705053,0 -1.33133,-0.421458 -1.599174,-1.071366 -0.177246,-0.429336 -0.177246,-0.898057 0,-1.3273935 0.177249,-0.4293337 0.508113,-0.7601969 0.937446,-0.9374462 0.212698,-0.086651 0.433275,-0.1339202 0.661728,-0.1339202 0.701154,0 1.331369,0.4214556 1.599173,1.0713664 z m -8.3958539,2.9999695 -0.018111,0.295741 c -0.2871317,0.05788 -0.5668953,0.154172 -0.8288319,0.285262 L 6.2852622,12.990088 C 6.1225748,12.806286 5.8657117,12.739702 5.6330114,12.819791 c -0.075824,0.0261 -0.1436331,0.06698 -0.2043281,0.120041 l -0.419642,0.369601 c -0.1213928,0.106112 -0.1925101,0.256339 -0.2040531,0.418225 -0.00893,0.160986 0.045065,0.317864 0.1511796,0.439254 l 0.1962877,0.221952 C 4.99132,14.634403 4.8601004,14.89889 4.7683555,15.17611 L 4.4726133,15.158 c -0.08049,-0.0045 -0.1591026,0.005 -0.2349263,0.03114 -0.2327004,0.08009 -0.3941755,0.290654 -0.4092821,0.535648 l -0.033047,0.558224 c -0.00893,0.160987 0.045065,0.317864 0.1511799,0.439255 0.1061152,0.121392 0.2563384,0.19251 0.4182243,0.204053 l 0.2957418,0.01811 c 0.058785,0.289747 0.1541719,0.566896 0.285262,0.828832 l -0.2219514,0.196287 c -0.1213891,0.106122 -0.1925108,0.256338 -0.204053,0.418225 -0.00893,0.160986 0.045065,0.317862 0.1511802,0.439256 l 0.3696027,0.419641 c 0.1626875,0.183803 0.4195497,0.250386 0.6522501,0.170297 0.075824,-0.0261 0.1436373,-0.06697 0.2043286,-0.120041 l 0.2219511,-0.196288 c 0.2455392,0.161135 0.5100265,0.292355 0.7872463,0.3841 l -0.01811,0.295744 c -0.019485,0.334231 0.2342727,0.621208 0.5685048,0.640693 l 0.5582232,0.03305 c 0.080495,0.0045 0.1591023,-0.005 0.2349258,-0.03114 0.2327003,-0.08009 0.3941759,-0.290654 0.4092834,-0.535647 l 0.01811,-0.295742 c 0.2871321,-0.05788 0.5668956,-0.154172 0.828832,-0.285262 l 0.1962878,0.221952 c 0.162687,0.183802 0.4195495,0.250386 0.6522495,0.170297 0.07583,-0.0261 0.143633,-0.06698 0.204329,-0.120041 l 0.419641,-0.369603 c 0.121393,-0.106112 0.192511,-0.256338 0.204053,-0.418225 0.0089,-0.160989 -0.04506,-0.317865 -0.15118,-0.439255 l -0.196286,-0.221951 c 0.161134,-0.245539 0.292354,-0.510026 0.3841,-0.787246 l 0.29574,0.01811 c 0.08049,0.0045 0.159103,-0.005 0.234928,-0.03114 v 0 c 0.232699,-0.08009 0.394176,-0.290654 0.409281,-0.535649 l 0.03305,-0.558221 c 0.0089,-0.160986 -0.04507,-0.317863 -0.15118,-0.439256 -0.106121,-0.121388 -0.256339,-0.19251 -0.418224,-0.204052 l -0.295742,-0.01811 c -0.05879,-0.289747 -0.154172,-0.566896 -0.285263,-0.828833 l 0.221952,-0.196288 c 0.121389,-0.106121 0.192511,-0.256337 0.204053,-0.418223 0.0089,-0.160986 -0.04507,-0.317863 -0.15118,-0.439256 l -0.369603,-0.419644 c -0.162682,-0.183804 -0.41955,-0.250386 -0.65225,-0.170296 -0.07583,0.0261 -0.143634,0.06698 -0.204329,0.120041 l -0.2219505,0.196287 c -0.245539,-0.161135 -0.5100269,-0.292355 -0.7872463,-0.3841 l 0.01811,-0.295741 C 9.1083625,12.577 9.0543697,12.420124 8.9482482,12.298735 8.8421362,12.177342 8.6919099,12.106224 8.530024,12.094682 l -0.5582233,-0.03305 c -0.080492,-0.0045 -0.159103,0.005 -0.2349267,0.03114 -0.2327004,0.08009 -0.394175,0.290655 -0.4083819,0.538264 z m 0.5151065,0.545022 0.030859,-0.513604 c 0.00146,-0.02974 0.022292,-0.04569 0.040595,-0.05199 0.00785,-0.0027 0.013979,-0.0018 0.022715,-0.002 l 0.558222,0.03305 c 0.021007,0.0015 0.033334,0.01192 0.038654,0.01887 0.0088,0.0087 0.016847,0.02344 0.014401,0.04184 l -0.030861,0.513608 c -0.00748,0.131244 0.076741,0.248475 0.2021164,0.281356 0.3638418,0.09702 0.7003331,0.259025 0.9981145,0.486984 0.103073,0.07857 0.25082,0.07451 0.3470495,-0.01125 l 0.385822,-0.340417 c 0.0069,-0.0053 0.01128,-0.0097 0.01914,-0.0124 0.01831,-0.0063 0.04453,-0.0065 0.064,0.01599 l 0.369603,0.419641 c 0.02036,0.02516 0.01815,0.06102 -0.0036,0.0831 l -0.385826,0.340419 c -0.09884,0.08666 -0.1202,0.228527 -0.05438,0.343315 0.19028,0.323447 0.309144,0.67732 0.361752,1.051074 0.01787,0.12837 0.12553,0.228758 0.254148,0.237129 l 0.513607,0.03086 c 0.02101,0.0015 0.03335,0.01193 0.03865,0.01887 0.0088,0.0087 0.01684,0.02343 0.0144,0.04183 l -0.03305,0.558225 c -0.0015,0.02974 -0.02229,0.04569 -0.04059,0.05199 -0.0078,0.0027 -0.01396,0.0019 -0.02272,0.002 l -0.513603,-0.03086 c -0.131241,-0.0075 -0.248475,0.07674 -0.28136,0.202108 -0.09702,0.363841 -0.259022,0.700332 -0.486984,0.998116 -0.07857,0.103072 -0.07451,0.250817 0.01124,0.347048 l 0.340416,0.385822 c 0.01415,0.01561 0.0169,0.0322 0.0144,0.04184 -0.0016,0.01225 -0.005,0.02802 -0.02147,0.03956 l -0.419643,0.369603 c -0.007,0.0053 -0.01128,0.0097 -0.01914,0.0124 -0.01831,0.0063 -0.04453,0.0065 -0.06399,-0.01599 L 9.7658555,18.778359 c -0.07602,-0.08496 -0.190853,-0.112699 -0.2928225,-0.0776 -0.01569,0.0054 -0.033113,0.01425 -0.047884,0.0223 -0.3217333,0.186761 -0.6799352,0.310045 -1.0510741,0.361752 -0.1283725,0.01786 -0.2287618,0.125521 -0.2371295,0.254149 l -0.030857,0.513608 c -0.00146,0.02974 -0.02229,0.04569 -0.040592,0.05199 -0.00785,0.0027 -0.013947,0.0019 -0.022711,0.002 l -0.558219,-0.03306 c -0.032359,-5.59e-4 -0.057136,-0.03005 -0.053955,-0.06331 l 0.030857,-0.513608 c 0.00747,-0.131239 -0.07674,-0.248474 -0.202112,-0.281358 -0.3638415,-0.09702 -0.7003325,-0.259023 -0.9981153,-0.486983 -0.103075,-0.07857 -0.2508187,-0.07451 -0.3470487,0.01124 l -0.3858217,0.340417 c -0.00697,0.0053 -0.011282,0.0097 -0.019125,0.0124 -0.018301,0.0063 -0.044539,0.0066 -0.063992,-0.016 L 5.0757023,18.456658 c -0.014149,-0.01561 -0.016928,-0.03219 -0.014397,-0.04183 0.00163,-0.01226 0.00498,-0.02802 0.018859,-0.03866 l 0.3858222,-0.34042 c 0.098846,-0.08666 0.1202018,-0.228526 0.054375,-0.343315 C 5.3300841,17.368987 5.2112136,17.015114 5.1586104,16.64136 5.140746,16.512986 5.0330887,16.412596 4.9044605,16.404228 l -0.5135914,-0.03082 c -0.021002,-0.0015 -0.033343,-0.01192 -0.038659,-0.01887 -0.00883,-0.0087 -0.016843,-0.02343 -0.014397,-0.04183 l 0.033047,-0.558224 c 0.00146,-0.02974 0.022292,-0.04568 0.040596,-0.05198 0.00785,-0.0027 0.013984,-0.0019 0.022705,-0.002 l 0.5136046,0.03086 c 0.13124,0.0075 0.2484745,-0.07674 0.2813557,-0.202116 0.097024,-0.363843 0.2590241,-0.700333 0.4869839,-0.998115 0.078574,-0.103072 0.074513,-0.250819 -0.011245,-0.347049 l -0.340409,-0.385796 c -0.014149,-0.01561 -0.016928,-0.03219 -0.014401,-0.04184 0.00163,-0.01226 0.00498,-0.02803 0.020576,-0.04217 l 0.4196419,-0.369603 c 0.00693,-0.0053 0.011279,-0.0097 0.019131,-0.0124 0.018303,-0.0063 0.044536,-0.0065 0.063991,0.016 l 0.3404158,0.385819 c 0.086658,0.09885 0.2311419,0.119301 0.3433148,0.05438 0.3217295,-0.18677 0.6799313,-0.310053 1.0510732,-0.361751 0.1266566,-0.01435 0.2279466,-0.119392 0.2354142,-0.250636 z M 6.824517,14.939249 c -0.3520019,0.31123 -0.5629144,0.743513 -0.5915826,1.212499 -0.028669,0.468987 0.1279103,0.923928 0.4391419,1.275932 0.4739176,0.535803 1.2173738,0.733196 1.8945584,0.500127 0.2196275,-0.07559 0.4196281,-0.191212 0.5938711,-0.347687 0.3520021,-0.311231 0.5629147,-0.743514 0.5915827,-1.212499 0.02867,-0.468988 -0.127911,-0.92393 -0.4391422,-1.275932 C 8.839028,14.555886 8.0955721,14.358493 7.4183877,14.591562 7.1987603,14.667152 6.9996605,14.785393 6.824517,14.939249 Z m 2.0783473,0.515829 c 0.2157444,0.244498 0.32283,0.555637 0.3032596,0.881124 -0.019572,0.325488 -0.1636084,0.620705 -0.4081068,0.836449 -0.1213902,0.106122 -0.2570132,0.187879 -0.4086604,0.240072 -0.4680155,0.161079 -0.9800254,0.0244 -1.3062996,-0.345822 -0.215744,-0.244498 -0.3228297,-0.555637 -0.3032596,-0.881124 0.019571,-0.325487 0.1636083,-0.620704 0.4081063,-0.83645 0.1213922,-0.106112 0.257013,-0.187879 0.4086601,-0.240072 0.4654276,-0.160188 0.9800516,-0.0244 1.3063004,0.345823 z M 21.581108,11.539684 c -0.256056,0 -0.460898,0.204844 -0.460898,0.460898 0,4.976764 -4.013069,9.036387 -8.971209,9.115531 l 0.628496,-0.628498 c 0.181566,-0.181564 0.181566,-0.470208 0,-0.651774 -0.181566,-0.181565 -0.47021,-0.181565 -0.651774,0 l -1.415283,1.415283 c -0.08845,0.08845 -0.135009,0.204843 -0.135009,0.325886 0,0.121044 0.04655,0.237432 0.135009,0.325888 l 1.415283,1.415281 c 0.08845,0.08845 0.209498,0.135011 0.325887,0.135011 0.116389,0 0.237432,-0.04655 0.325887,-0.135011 0.181566,-0.181566 0.181566,-0.470208 0,-0.651775 l -0.633151,-0.633152 c 5.470249,-0.06984 9.897658,-4.543798 9.897658,-10.03267 -4.6e-5,-0.256054 -0.204843,-0.460898 -0.460896,-0.460898 z M 1.9579955,12.000582 c 0,0.256055 0.2048435,0.460897 0.4608978,0.460897 0.2560542,0 0.4608976,-0.204842 0.4608976,-0.460897 0,-4.9767634 4.0130682,-9.0363869 8.9712091,-9.1155309 l -0.628497,0.6284968 c -0.181565,0.1815657 -0.181565,0.4702086 0,0.6517744 0.08845,0.088455 0.209499,0.1350104 0.325888,0.1350104 0.116388,0 0.237432,-0.046555 0.325887,-0.1350104 L 13.28956,2.7500407 c 0.181565,-0.1815658 0.181565,-0.4702087 0,-0.6517744 L 11.874278,0.68298476 c -0.181567,-0.18156571 -0.47021,-0.18156571 -0.651776,0 -0.181565,0.18156571 -0.181565,0.47020864 0,0.65177434 l 0.633153,0.6331523 C 6.3854058,2.0377443 1.9579955,6.5117101 1.9579955,12.000582 Z"/>
+</vector>
diff --git a/packages/SystemUI/res/drawable/ic_restart_recovery.xml b/packages/SystemUI/res/drawable/ic_restart_recovery.xml
new file mode 100644
index 000000000000..c15e6de8f7e7
--- /dev/null
+++ b/packages/SystemUI/res/drawable/ic_restart_recovery.xml
@@ -0,0 +1,26 @@
+<!--
+    Copyright (C) 2016 The Android Open Source Project
+    Copyright (C) 2017 The ABC rom
+
+    Licensed under the Apache License, Version 2.0 (the "License");
+    you may not use this file except in compliance with the License.
+    You may obtain a copy of the License at
+
+         http://www.apache.org/licenses/LICENSE-2.0
+
+    Unless required by applicable law or agreed to in writing, software
+    distributed under the License is distributed on an "AS IS" BASIS,
+    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+    See the License for the specific language governing permissions and
+    limitations under the License.
+-->
+<vector xmlns:android="http://schemas.android.com/apk/res/android"
+        android:width="24.0dp"
+        android:height="24.0dp"
+        android:viewportHeight="24.0"
+        android:viewportWidth="24.0"
+        android:tint="?android:attr/colorControlNormal">
+    <path
+        android:fillColor="#FF000000"
+        android:pathData="m 12.931084,5.8599357 -0.190878,0.4608976 c -0.48883,-0.065177 -0.986972,-0.065177 -1.475803,0 L 11.073527,5.8599357 C 10.915238,5.4781821 10.542794,5.231439 10.128453,5.231439 c -0.1350105,0 -0.2653645,0.027933 -0.3910645,0.079144 L 8.8668044,5.6690592 c -0.2513991,0.1024215 -0.446931,0.3026096 -0.5540088,0.5540083 -0.1024215,0.2513986 -0.1024215,0.5307306 0,0.7821293 L 8.5036731,7.4660944 C 8.1126082,7.7687036 7.7587875,8.1178685 7.4608339,8.5089331 L 6.9999361,8.3180564 c -0.125699,-0.051211 -0.2560543,-0.079144 -0.3910648,-0.079144 -0.4143422,0 -0.786785,0.2467431 -0.9450729,0.6284967 L 5.3053224,9.737994 c -0.1024214,0.2513975 -0.1024214,0.530731 0,0.782129 0.1024215,0.251399 0.3026099,0.446931 0.5540081,0.554008 l 0.4608977,0.190877 c -0.065174,0.493486 -0.065174,0.986973 0,1.475804 l -0.4608977,0.190877 c -0.2513982,0.102424 -0.446931,0.302609 -0.5540081,0.554008 -0.1024214,0.251398 -0.1024214,0.53073 0,0.78213 l 0.358476,0.870583 c 0.1582879,0.381754 0.5307307,0.628497 0.9450729,0.628497 0.1350105,0 0.2653658,-0.02793 0.3910648,-0.07914 l 0.4608978,-0.190878 c 0.3026089,0.391065 0.6517743,0.744886 1.0428392,1.04284 l -0.1908775,0.460896 c -0.2141541,0.521419 0.032587,1.117328 0.5540088,1.331483 l 0.8705841,0.358476 c 0.1257,0.05121 0.256054,0.07914 0.3910645,0.07914 0.414341,0 0.786785,-0.246744 0.945074,-0.628496 l 0.190875,-0.460897 c 0.488831,0.06518 0.986974,0.06518 1.475804,0 l 0.190878,0.460898 c 0.158288,0.381753 0.53073,0.628496 0.945071,0.628496 0.135012,0 0.265365,-0.02793 0.391065,-0.07914 l 0.870585,-0.358476 c 0.251398,-0.102425 0.44693,-0.30261 0.554009,-0.55401 0.102425,-0.251398 0.102425,-0.53073 0,-0.782128 l -0.190879,-0.460897 c 0.391066,-0.302609 0.744886,-0.651774 1.04284,-1.042839 l 0.460897,0.190877 c 0.1257,0.05121 0.256054,0.07914 0.391065,0.07914 v 0 c 0.414343,0 0.786785,-0.246743 0.945073,-0.628498 l 0.358476,-0.870582 c 0.102424,-0.2514 0.102424,-0.530732 0,-0.782131 -0.102425,-0.251398 -0.30261,-0.446931 -0.554008,-0.554007 L 17.68438,12.736157 c 0.06518,-0.493488 0.06518,-0.986974 0,-1.475805 l 0.460898,-0.190878 c 0.251398,-0.102424 0.446931,-0.302608 0.554008,-0.554007 0.102424,-0.251399 0.102424,-0.5307315 0,-0.7821304 L 18.34081,8.8627535 C 18.182522,8.4809999 17.81008,8.2342568 17.395737,8.2342568 c -0.135011,0 -0.265365,0.027933 -0.391065,0.079144 L 16.543776,8.5042775 C 16.241166,8.1132128 15.892001,7.7593926 15.500935,7.4614385 l 0.190879,-0.4608976 c 0.102425,-0.2513988 0.102425,-0.5307305 0,-0.7821292 C 15.589392,5.9670129 15.389203,5.7714806 15.137805,5.6644034 L 14.26722,5.3059275 c -0.125699,-0.051211 -0.256053,-0.079144 -0.391065,-0.079144 -0.414341,0 -0.786784,0.2467431 -0.945071,0.6331522 z m 0.521419,1.1499162 0.330543,-0.8007513 c 0.01862,-0.046555 0.06052,-0.060522 0.09311,-0.060522 0.01397,0 0.02327,0.00466 0.03725,0.00931 l 0.870583,0.358476 c 0.03259,0.013967 0.04655,0.037244 0.05121,0.051211 0.0093,0.018622 0.01396,0.046555 0,0.074488 l -0.33055,0.8007559 c -0.08381,0.2048434 -0.01396,0.4376199 0.167599,0.5586637 0.526075,0.3538205 0.973006,0.7960959 1.322171,1.3221716 0.121044,0.1815652 0.358476,0.2560543 0.558664,0.1722546 l 0.800751,-0.3305433 c 0.01397,-0.00464 0.02328,-0.00931 0.03725,-0.00931 0.03259,0 0.07448,0.013966 0.09311,0.060519 l 0.358478,0.8705849 c 0.01862,0.05121 -0.0046,0.107077 -0.05121,0.130355 l -0.800759,0.330543 c -0.204843,0.08381 -0.316575,0.297953 -0.274676,0.516763 0.1257,0.619186 0.121045,1.247683 0,1.871524 -0.04189,0.214155 0.07449,0.432964 0.274676,0.516764 l 0.800753,0.330543 c 0.03259,0.01397 0.04655,0.03725 0.05121,0.05121 0.0093,0.01862 0.01397,0.04655 0,0.07448 l -0.358477,0.870589 c -0.01862,0.04655 -0.06052,0.06052 -0.09311,0.06052 -0.01396,0 -0.02328,-0.0046 -0.03725,-0.0093 l -0.80075,-0.330544 c -0.204845,-0.0838 -0.437621,-0.01397 -0.558665,0.1676 -0.35382,0.526075 -0.796095,0.973006 -1.322172,1.322171 -0.181564,0.121043 -0.256054,0.358475 -0.172254,0.558663 l 0.330542,0.800751 c 0.01397,0.03259 0.0093,0.06052 0,0.07449 -0.0093,0.01862 -0.02327,0.04189 -0.05586,0.05121 l -0.870585,0.358477 c -0.01396,0.0046 -0.02327,0.0093 -0.03725,0.0093 -0.03259,0 -0.07448,-0.01396 -0.09311,-0.06052 l -0.330543,-0.800752 c -0.07448,-0.176911 -0.242087,-0.283988 -0.423653,-0.283988 -0.02793,0 -0.06052,0.0046 -0.08845,0.0093 -0.614531,0.121044 -1.252338,0.121044 -1.871524,0 -0.214155,-0.0419 -0.432965,0.07448 -0.516765,0.274676 l -0.330543,0.800759 c -0.01862,0.04655 -0.06052,0.06052 -0.09311,0.06052 -0.01397,0 -0.02327,-0.0046 -0.03725,-0.0093 L 9.2113154,17.475485 c -0.051208,-0.01862 -0.074494,-0.07914 -0.051208,-0.130356 L 9.4906495,16.544378 C 9.5744445,16.339536 9.5046155,16.106759 9.3230502,15.985714 8.7969758,15.631893 8.3500448,15.18962 8.0008794,14.663544 7.8798356,14.481977 7.6424034,14.407489 7.4422161,14.491289 l -0.8007517,0.330543 c -0.013966,0.0046 -0.023276,0.0093 -0.037242,0.0093 -0.032587,0 -0.074494,-0.01397 -0.093112,-0.06052 L 6.1526357,13.900039 c -0.013966,-0.03259 -0.00931,-0.06052 0,-0.07448 0.00931,-0.01862 0.023277,-0.04189 0.051208,-0.05121 l 0.8007518,-0.330542 c 0.2048434,-0.0838 0.3165766,-0.297954 0.2746763,-0.516764 -0.125699,-0.619186 -0.1210437,-1.247683 0,-1.871523 0.041898,-0.21416 -0.074484,-0.432969 -0.2746761,-0.51677 L 6.203844,10.208208 c -0.032587,-0.01397 -0.046553,-0.03724 -0.051208,-0.05121 -0.00931,-0.01862 -0.013966,-0.04655 0,-0.07448 L 6.511111,9.2119333 c 0.018621,-0.046553 0.060519,-0.060519 0.093112,-0.060519 0.013966,0 0.023276,0.00464 0.037242,0.00931 L 7.4422161,9.4912678 C 7.6470595,9.5750598 7.8798356,9.5052304 8.0008794,9.323666 8.3547001,8.7975906 8.7969758,8.3506596 9.3230502,8.0014947 9.5046163,7.880451 9.5791045,7.6430188 9.4953048,7.442831 L 9.1647581,6.642065 c -0.013966,-0.032589 -0.00931,-0.060521 0,-0.074488 0.00931,-0.018622 0.023276,-0.041899 0.055863,-0.055866 L 10.091207,6.1532347 c 0.01396,-0.00466 0.02327,-0.00931 0.03725,-0.00931 0.03259,0 0.07449,0.013967 0.09311,0.060521 l 0.330541,0.8007514 c 0.0838,0.2048434 0.30261,0.3165761 0.516764,0.2746764 0.614531,-0.1210439 1.252338,-0.1210439 1.871523,0 0.209499,0.046555 0.42831,-0.065177 0.51211,-0.2700209 z m -2.588475,2.2486219 c -0.730918,0.302609 -1.3035499,0.8752402 -1.6061588,1.6061582 -0.3026098,0.730919 -0.3026098,1.540981 0,2.271901 0.4608973,1.112671 1.5363248,1.834279 2.7421078,1.834279 0.391065,0 0.772818,-0.07448 1.13595,-0.228122 0.730918,-0.30261 1.303549,-0.87524 1.606158,-1.606157 0.30261,-0.73092 0.30261,-1.540982 0,-2.271901 -0.460898,-1.1126716 -1.536325,-1.8342794 -2.742108,-1.8342794 -0.391064,0 -0.772819,0.079144 -1.135949,0.2281212 z m 3.026095,1.9599792 c 0.209499,0.507453 0.209499,1.061461 0,1.568914 -0.2095,0.507453 -0.600563,0.898518 -1.108017,1.108017 -0.251399,0.102424 -0.512108,0.158288 -0.782129,0.158288 -0.83334,0 -1.573569,-0.498143 -1.890146,-1.266305 -0.2094985,-0.507453 -0.2094985,-1.061461 0,-1.568914 0.209499,-0.507453 0.600564,-0.898517 1.108017,-1.108017 0.251398,-0.102421 0.512109,-0.1582885 0.782129,-0.1582885 0.828732,0 1.573616,0.4981415 1.890146,1.2663055 z m 7.690985,0.321231 c -0.256056,0 -0.460898,0.204844 -0.460898,0.460898 0,4.976764 -4.013069,9.036387 -8.971209,9.115531 l 0.628496,-0.628498 c 0.181566,-0.181564 0.181566,-0.470208 0,-0.651774 -0.181566,-0.181565 -0.47021,-0.181565 -0.651774,0 l -1.415283,1.415283 c -0.08845,0.08845 -0.135009,0.204843 -0.135009,0.325886 0,0.121044 0.04655,0.237432 0.135009,0.325888 l 1.415283,1.415281 c 0.08845,0.08845 0.209498,0.135011 0.325887,0.135011 0.116389,0 0.237432,-0.04655 0.325887,-0.135011 0.181566,-0.181566 0.181566,-0.470208 0,-0.651775 l -0.633151,-0.633152 c 5.470249,-0.06984 9.897658,-4.543798 9.897658,-10.03267 -4.6e-5,-0.256054 -0.204843,-0.460898 -0.460896,-0.460898 z M 1.9579955,12.000582 c 0,0.256055 0.2048435,0.460897 0.4608978,0.460897 0.2560542,0 0.4608976,-0.204842 0.4608976,-0.460897 0,-4.9767634 4.0130682,-9.0363869 8.9712091,-9.1155309 l -0.628497,0.6284968 c -0.181565,0.1815657 -0.181565,0.4702086 0,0.6517744 0.08845,0.088455 0.209499,0.1350104 0.325888,0.1350104 0.116388,0 0.237432,-0.046555 0.325887,-0.1350104 L 13.28956,2.7500407 c 0.181565,-0.1815658 0.181565,-0.4702087 0,-0.6517744 L 11.874278,0.68298476 c -0.181567,-0.18156571 -0.47021,-0.18156571 -0.651776,0 -0.181565,0.18156571 -0.181565,0.47020864 0,0.65177434 l 0.633153,0.6331523 C 6.3854058,2.0377443 1.9579955,6.5117101 1.9579955,12.000582 Z"/>
+</vector>
diff --git a/packages/SystemUI/res/drawable/ic_restart_ui.xml b/packages/SystemUI/res/drawable/ic_restart_ui.xml
new file mode 100644
index 000000000000..ddf5ca88232f
--- /dev/null
+++ b/packages/SystemUI/res/drawable/ic_restart_ui.xml
@@ -0,0 +1,26 @@
+<!--
+    Copyright (C) 2016 The Android Open Source Project
+    Copyright (C) 2017 The ABC rom
+
+    Licensed under the Apache License, Version 2.0 (the "License");
+    you may not use this file except in compliance with the License.
+    You may obtain a copy of the License at
+
+         http://www.apache.org/licenses/LICENSE-2.0
+
+    Unless required by applicable law or agreed to in writing, software
+    distributed under the License is distributed on an "AS IS" BASIS,
+    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+    See the License for the specific language governing permissions and
+    limitations under the License.
+-->
+<vector xmlns:android="http://schemas.android.com/apk/res/android"
+        android:width="24.0dp"
+        android:height="24.0dp"
+        android:viewportHeight="24.0"
+        android:viewportWidth="24.0"
+        android:tint="?android:attr/colorControlNormal">
+    <path
+        android:fillColor="#FF000000"
+        android:pathData="m 8.7089845,1.146422 c -0.049012,0.00696 -0.097435,0.023733 -0.1425781,0.050781 C 8.3858333,1.3053947 8.327355,1.5381144 8.435547,1.7186876 L 9.3867188,3.3046251 C 7.5478452,4.2551101 6.2851564,6.1716336 6.2851564,8.380797 c 0,0.2106686 0.1705717,0.3808594 0.3808593,0.3808594 H 17.333985 c 0.210288,0 0.380859,-0.1701908 0.380859,-0.3808594 C 17.714463,6.1720145 16.452156,4.2554911 14.613282,3.3046251 L 15.564454,1.7186876 C 15.672645,1.5381144 15.614167,1.3053947 15.433594,1.1972032 15.25264,1.0886308 15.020302,1.1471086 14.91211,1.3280626 l -1.003906,1.671875 C 13.310485,2.7873642 12.669722,2.6659532 12.000001,2.6659532 c -0.66972,0 -1.308531,0.121411 -1.90625,0.3339844 L 9.0898438,1.3280626 C 9.0086998,1.192347 8.8560217,1.1255468 8.7089845,1.146422 Z m 3.2910165,2.28125 c 2.602691,0 4.742449,2.0187181 4.9375,4.5722656 H 7.0625001 C 7.2575495,5.4463901 9.397309,3.427672 12.000001,3.427672 Z M 9.341797,5.4706407 c -0.138668,0 -0.2519532,0.1132852 -0.2519532,0.2519531 V 6.224547 c 0,0.1386679 0.1132852,0.2519531 0.2519532,0.2519531 h 0.5019531 c 0.138668,0 0.2519539,-0.1132852 0.2519539,-0.2519531 V 5.7225938 c 0,-0.138668 -0.1132859,-0.2519531 -0.2519539,-0.2519531 z m 4.814454,0 c -0.138669,0 -0.251954,0.1132852 -0.251954,0.2519531 V 6.224547 c 0,0.1386679 0.113285,0.2519531 0.251954,0.2519531 h 0.501953 c 0.138667,0 0.251953,-0.1132852 0.251953,-0.2519531 V 5.7225938 c 0,-0.138668 -0.113285,-0.2519531 -0.251953,-0.2519531 z m -9.5839853,3.671875 c -0.7352449,0 -1.3339843,0.5999304 -1.3339843,1.3359383 v 5.330078 c 0,0.736007 0.5987394,1.333984 1.3339843,1.333984 0.7352449,0 1.3320313,-0.597977 1.3320313,-1.333984 v -5.330078 c 0,-0.7360079 -0.5967864,-1.3359383 -1.3320313,-1.3359383 z m 2.09375,0 c -0.2102877,0 -0.3808593,0.1701908 -0.3808593,0.3808594 v 7.6855469 c 0,1.014486 0.8265495,1.837891 1.8417968,1.837891 h 0.4453125 v 2.289062 c 0,0.838865 0.6830484,1.521485 1.5234383,1.521485 0.840388,0 1.523437,-0.682619 1.523437,-1.521485 v -2.289062 h 0.761719 v 2.289062 c 0,0.838865 0.683048,1.521485 1.523437,1.521485 0.840389,0 1.523438,-0.682619 1.523438,-1.521485 v -2.289062 h 0.445312 c 1.015629,0 1.841797,-0.823405 1.841797,-1.837891 V 9.5233751 c 0,-0.2106686 -0.17019,-0.3808594 -0.380859,-0.3808594 z m 12.7617193,0 c -0.735245,0 -1.332031,0.5999304 -1.332031,1.3359383 v 5.330078 c 0,0.736007 0.596786,1.333984 1.332031,1.333984 0.735245,0 1.333984,-0.597977 1.333984,-1.333984 v -5.330078 c 0,-0.7360079 -0.598739,-1.3359383 -1.333984,-1.3359383 z M 4.5722657,9.9042345 c 0.3150506,0 0.5703125,0.2584065 0.5703125,0.5742195 v 5.330078 c 0,0.315813 -0.2552619,0.572265 -0.5703125,0.572265 -0.3150505,0 -0.5722656,-0.256452 -0.5722656,-0.572265 v -5.330078 c 0,-0.315813 0.2572151,-0.5742195 0.5722656,-0.5742195 z m 2.4746094,0 h 9.9062499 v 7.3046875 c 0,0.594292 -0.484644,1.076172 -1.080078,1.076172 h -0.826172 c -0.210288,0 -0.380859,0.170192 -0.380859,0.38086 v 2.669921 c 0,0.419051 -0.341525,0.759766 -0.761719,0.759766 -0.420195,0 -0.761718,-0.341095 -0.761718,-0.759766 v -2.669921 c 0,-0.210668 -0.170572,-0.38086 -0.38086,-0.38086 h -1.523437 c -0.210287,0 -0.38086,0.170192 -0.38086,0.38086 v 2.669921 c 0,0.419051 -0.341524,0.759766 -0.761718,0.759766 -0.4201959,0 -0.7617195,-0.341095 -0.7617195,-0.759766 v -2.669921 c 0,-0.210668 -0.1705724,-0.38086 -0.3808594,-0.38086 H 8.1269532 c -0.5954339,0 -1.0800781,-0.482261 -1.0800781,-1.076172 z m 12.3808599,0 c 0.31505,0 0.572266,0.2584065 0.572266,0.5742195 v 5.330078 c 0,0.315813 -0.257216,0.572265 -0.572266,0.572265 -0.315051,0 -0.570313,-0.256452 -0.570313,-0.572265 v -5.330078 c 0,-0.315813 0.255262,-0.5742195 0.570313,-0.5742195 z"/>
+</vector>
diff --git a/packages/SystemUI/res/values/aospa_strings.xml b/packages/SystemUI/res/values/aospa_strings.xml
index 5f519136978f..2500e573c12d 100644
--- a/packages/SystemUI/res/values/aospa_strings.xml
+++ b/packages/SystemUI/res/values/aospa_strings.xml
@@ -52,4 +52,10 @@
     <!-- Name of the VoWiFi status bar icon. -->
     <string name="status_bar_vowifi">Wi-Fi calling (VoWiFi)</string>
 
+    <!-- Advanced Reboot -->
+    <string name="global_action_restart_advanced">Advanced</string>
+    <string name="global_action_restart_recovery">Recovery</string>
+    <string name="global_action_restart_bootloader">Bootloader</string>
+    <string name="global_action_restart_ui">SystemUI</string>
+
 </resources>
diff --git a/packages/SystemUI/src/com/android/systemui/globalactions/GlobalActionsComponent.java b/packages/SystemUI/src/com/android/systemui/globalactions/GlobalActionsComponent.java
index 9f321d83d292..dab169896d13 100644
--- a/packages/SystemUI/src/com/android/systemui/globalactions/GlobalActionsComponent.java
+++ b/packages/SystemUI/src/com/android/systemui/globalactions/GlobalActionsComponent.java
@@ -120,4 +120,12 @@ public class GlobalActionsComponent implements CoreStartable, Callbacks, GlobalA
         } catch (RemoteException e) {
         }
     }
+
+    @Override
+    public void advancedReboot(String mode) {
+        try {
+            mBarService.advancedReboot(mode);
+        } catch (RemoteException e) {
+        }
+    }
 }
diff --git a/packages/SystemUI/src/com/android/systemui/globalactions/GlobalActionsDialogLite.java b/packages/SystemUI/src/com/android/systemui/globalactions/GlobalActionsDialogLite.java
index 5df3d44a8b89..a8848f69e156 100644
--- a/packages/SystemUI/src/com/android/systemui/globalactions/GlobalActionsDialogLite.java
+++ b/packages/SystemUI/src/com/android/systemui/globalactions/GlobalActionsDialogLite.java
@@ -1,3 +1,4 @@
+
 /*
  * Copyright 2021 The Android Open Source Project
  *
@@ -59,6 +60,8 @@ import android.os.Handler;
 import android.os.IBinder;
 import android.os.Message;
 import android.os.RemoteException;
+import android.os.PowerManager;
+import android.os.Process;
 import android.os.SystemProperties;
 import android.os.UserHandle;
 import android.os.UserManager;
@@ -596,6 +599,45 @@ public class GlobalActionsDialogLite implements DialogInterface.OnDismissListene
 
         ShutDownAction shutdownAction = new ShutDownAction();
         RestartAction restartAction = new RestartAction();
+
+        AdvancedAction restartRecoveryAction = new AdvancedAction(
+                com.android.systemui.R.drawable.ic_restart_recovery,
+                com.android.systemui.R.string.global_action_restart_recovery
+        ) {
+            @Override
+            public void onPress() {
+                mHandler.sendEmptyMessage(MESSAGE_DISMISS);
+                mWindowManagerFuncs.advancedReboot(PowerManager.REBOOT_RECOVERY);
+            }
+        };
+
+        AdvancedAction restartBootloaderAction = new AdvancedAction(
+                com.android.systemui.R.drawable.ic_restart_bootloader,
+                com.android.systemui.R.string.global_action_restart_bootloader
+        ) {
+            @Override
+            public void onPress() {
+                mHandler.sendEmptyMessage(MESSAGE_DISMISS);
+                mWindowManagerFuncs.advancedReboot(PowerManager.REBOOT_BOOTLOADER);
+            }
+        };
+
+        AdvancedAction restartSystemUiAction = new AdvancedAction(
+                com.android.systemui.R.drawable.ic_restart_ui,
+                com.android.systemui.R.string.global_action_restart_ui
+        ) {
+            @Override
+            public void onPress() {
+                /*
+                  No time and need to dismiss the dialog here, just kill systemui straight after telling to
+                  policy/GlobalActions that we hid the dialog within the kill action itself so its onStatusBarConnectedChanged
+                  won't show the LegacyGlobalActions after systemui restart.
+                */
+                mWindowManagerFuncs.onGlobalActionsHidden();
+                Process.killProcess(Process.myPid());
+            }
+        };
+
         ArraySet<String> addedKeys = new ArraySet<>();
         List<Action> tempActions = new ArrayList<>();
         CurrentUserProvider currentUser = new CurrentUserProvider();
@@ -606,79 +648,97 @@ public class GlobalActionsDialogLite implements DialogInterface.OnDismissListene
             addedKeys.add(GLOBAL_ACTION_KEY_EMERGENCY);
         }
 
-        for (int i = 0; i < defaultActions.length; i++) {
-            String actionKey = defaultActions[i];
+        for (String actionKey: defaultActions) {
             if (addedKeys.contains(actionKey)) {
                 // If we already have added this, don't add it again.
                 continue;
             }
-            if (GLOBAL_ACTION_KEY_POWER.equals(actionKey)) {
-                addIfShouldShowAction(tempActions, shutdownAction);
-            } else if (GLOBAL_ACTION_KEY_AIRPLANE.equals(actionKey)) {
-                addIfShouldShowAction(tempActions, mAirplaneModeOn);
-            } else if (GLOBAL_ACTION_KEY_BUGREPORT.equals(actionKey)) {
-                if (shouldDisplayBugReport(currentUser.get())) {
-                    addIfShouldShowAction(tempActions, new BugReportAction());
-                }
-            } else if (GLOBAL_ACTION_KEY_SILENT.equals(actionKey)) {
-                if (mShowSilentToggle) {
-                    addIfShouldShowAction(tempActions, mSilentModeAction);
-                }
-            } else if (GLOBAL_ACTION_KEY_USERS.equals(actionKey)) {
-                if (SystemProperties.getBoolean("fw.power_user_switcher", false)) {
-                    addUserActions(tempActions, currentUser.get());
-                }
-            } else if (GLOBAL_ACTION_KEY_SETTINGS.equals(actionKey)) {
-                addIfShouldShowAction(tempActions, getSettingsAction());
-            } else if (GLOBAL_ACTION_KEY_LOCKDOWN.equals(actionKey)) {
-                if (shouldDisplayLockdown(currentUser.get())) {
-                    addIfShouldShowAction(tempActions, new LockDownAction());
-                }
-            } else if (GLOBAL_ACTION_KEY_VOICEASSIST.equals(actionKey)) {
-                addIfShouldShowAction(tempActions, getVoiceAssistAction());
-            } else if (GLOBAL_ACTION_KEY_ASSIST.equals(actionKey)) {
-                addIfShouldShowAction(tempActions, getAssistAction());
-            } else if (GLOBAL_ACTION_KEY_RESTART.equals(actionKey)) {
-                addIfShouldShowAction(tempActions, restartAction);
-            } else if (GLOBAL_ACTION_KEY_SCREENSHOT.equals(actionKey)) {
-                addIfShouldShowAction(tempActions, new ScreenshotAction());
-            } else if (GLOBAL_ACTION_KEY_LOGOUT.equals(actionKey)) {
-                // TODO(b/206032495): should call mDevicePolicyManager.getLogoutUserId() instead of
-                // hardcode it to USER_SYSTEM so it properly supports headless system user mode
-                // (and then call mDevicePolicyManager.clearLogoutUser() after switched)
-                if (mDevicePolicyManager.isLogoutEnabled()
+            switch (actionKey) {
+                case GLOBAL_ACTION_KEY_POWER:
+                    addIfShouldShowAction(tempActions, shutdownAction);
+                    break;
+                case GLOBAL_ACTION_KEY_AIRPLANE:
+                    addIfShouldShowAction(tempActions, mAirplaneModeOn);
+                    break;
+                case GLOBAL_ACTION_KEY_BUGREPORT:
+                    if (shouldDisplayBugReport(currentUser.get())) {
+                        addIfShouldShowAction(tempActions, new BugReportAction());
+                    }
+                    break;
+                case GLOBAL_ACTION_KEY_SILENT:
+                    if (mShowSilentToggle) {
+                        addIfShouldShowAction(tempActions, mSilentModeAction);
+                    }
+                    break;
+                case GLOBAL_ACTION_KEY_USERS:
+                    if (SystemProperties.getBoolean("fw.power_user_switcher", false)) {
+                        addUserActions(tempActions, currentUser.get());
+                    }
+                    break;
+                case GLOBAL_ACTION_KEY_SETTINGS:
+                    addIfShouldShowAction(tempActions, getSettingsAction());
+                    break;
+                case GLOBAL_ACTION_KEY_LOCKDOWN:
+                    if (shouldDisplayLockdown(currentUser.get())) {
+                        addIfShouldShowAction(tempActions, new LockDownAction());
+                    }
+                    break;
+                case GLOBAL_ACTION_KEY_VOICEASSIST:
+                    addIfShouldShowAction(tempActions, getVoiceAssistAction());
+                    break;
+                case GLOBAL_ACTION_KEY_ASSIST:
+                    addIfShouldShowAction(tempActions, getAssistAction());
+                    break;
+                case GLOBAL_ACTION_KEY_RESTART:
+                    addIfShouldShowAction(tempActions, restartAction);
+                    break;
+                case GLOBAL_ACTION_KEY_SCREENSHOT:
+                    addIfShouldShowAction(tempActions, new ScreenshotAction());
+                    break;
+                case GLOBAL_ACTION_KEY_LOGOUT:
+                    // TODO(b/206032495): should call mDevicePolicyManager.getLogoutUserId() instead of
+                    // hardcode it to USER_SYSTEM so it properly supports headless system user mode
+                    // (and then call mDevicePolicyManager.clearLogoutUser() after switched)
+                    if (mDevicePolicyManager.isLogoutEnabled()
                         && currentUser.get() != null
                         && currentUser.get().id != UserHandle.USER_SYSTEM) {
-                    addIfShouldShowAction(tempActions, new LogoutAction());
-                }
-            } else if (GLOBAL_ACTION_KEY_EMERGENCY.equals(actionKey)) {
-                if (shouldDisplayEmergency()) {
-                    addIfShouldShowAction(tempActions, new EmergencyDialerAction());
-                }
-            } else {
-                Log.e(TAG, "Invalid global action key " + actionKey);
+                            addIfShouldShowAction(tempActions, new LogoutAction());
+                    }
+                    break;
+                case GLOBAL_ACTION_KEY_EMERGENCY:
+                    if (shouldDisplayEmergency()) {
+                        addIfShouldShowAction(tempActions, new EmergencyDialerAction());
+                    }
+                    break;
+                default:
+                    Log.e(TAG, "Invalid global action key " + actionKey);
             }
             // Add here so we don't add more than one.
             addedKeys.add(actionKey);
         }
 
-        // replace power and restart with a single power options action, if needed
-        if (tempActions.contains(shutdownAction) && tempActions.contains(restartAction)
-                && tempActions.size() > getMaxShownPowerItems()) {
-            // transfer shutdown and restart to their own list of power actions
-            int powerOptionsIndex = Math.min(tempActions.indexOf(restartAction),
-                    tempActions.indexOf(shutdownAction));
-            tempActions.remove(shutdownAction);
+        if (tempActions.contains(restartAction)) {
+            // transfer restart and advanced restart to their own list of power actions
+            // and position it where Reset button was supposed to be
+            int powerOptionsIndex = tempActions.indexOf(restartAction);
             tempActions.remove(restartAction);
-            mPowerItems.add(shutdownAction);
             mPowerItems.add(restartAction);
+            mPowerItems.add(restartBootloaderAction);
+            mPowerItems.add(restartRecoveryAction);
+            mPowerItems.add(restartSystemUiAction);
 
-            // add the PowerOptionsAction after Emergency, if present
+            // add the PowerOptionsAction after Emergency and Shutdown action, if present
             tempActions.add(powerOptionsIndex, new PowerOptionsAction());
         }
-        for (Action action : tempActions) {
-            addActionItem(action);
+        // Add also Power to power actions list, if needed
+        if (tempActions.contains(shutdownAction)
+                /*tempActions.size gets in count already PowerOptionsAction if added*/
+                && tempActions.size() > getMaxShownPowerItems()) {
+            tempActions.remove(shutdownAction);
+            mPowerItems.add(shutdownAction);
         }
+
+        tempActions.forEach(this::addActionItem);
     }
 
     protected void onRefresh() {
@@ -781,8 +841,8 @@ public class GlobalActionsDialogLite implements DialogInterface.OnDismissListene
     @VisibleForTesting
     protected final class PowerOptionsAction extends SinglePressAction {
         private PowerOptionsAction() {
-            super(com.android.systemui.R.drawable.ic_settings_power,
-                    R.string.global_action_power_options);
+            super(com.android.systemui.R.drawable.ic_restart_advanced,
+                    com.android.systemui.R.string.global_action_restart_advanced);
         }
 
         @Override
@@ -1464,12 +1524,31 @@ public class GlobalActionsDialogLite implements DialogInterface.OnDismissListene
     /**
      * The adapter used for items in the overflow menu.
      */
-    public class MyPowerOptionsAdapter extends BaseAdapter {
+    public class MyPowerOptionsAdapter extends MultiListAdapter {
+        public int countSeparatedItems() {
+            return 0;
+        }
+
         @Override
-        public int getCount() {
+        public int countListItems() {
             return mPowerItems.size();
         }
 
+        @Override
+        public int getCount() {
+            return countListItems();
+        }
+
+        @Override
+        public boolean isEnabled(int position) {
+            return true;
+        }
+
+        @Override
+        public boolean areAllItemsEnabled() {
+            return true;
+        }
+
         @Override
         public Action getItem(int position) {
             return mPowerItems.get(position);
@@ -1482,64 +1561,29 @@ public class GlobalActionsDialogLite implements DialogInterface.OnDismissListene
 
         @Override
         public View getView(int position, View convertView, ViewGroup parent) {
-            Action action = getItem(position);
+            final Action action = getItem(position);
             if (action == null) {
                 Log.w(TAG, "No power options action found at position: " + position);
                 return null;
             }
-            int viewLayoutResource = com.android.systemui.R.layout.global_actions_power_item;
-            View view = convertView != null ? convertView
-                    : LayoutInflater.from(mContext).inflate(viewLayoutResource, parent, false);
+            final View view = action.create(mContext, convertView,
+                parent, LayoutInflater.from(mContext));
             view.setOnClickListener(v -> onClickItem(position));
-            if (action instanceof LongPressAction) {
-                view.setOnLongClickListener(v -> onLongClickItem(position));
-            }
-            ImageView icon = view.findViewById(R.id.icon);
-            TextView messageView = view.findViewById(R.id.message);
-            messageView.setSelected(true); // necessary for marquee to work
-
-            icon.setImageDrawable(action.getIcon(mContext));
-            icon.setScaleType(ScaleType.CENTER_CROP);
-
-            if (action.getMessage() != null) {
-                messageView.setText(action.getMessage());
-            } else {
-                messageView.setText(action.getMessageResId());
-            }
             return view;
         }
 
-        private boolean onLongClickItem(int position) {
-            final Action action = getItem(position);
-            if (action instanceof LongPressAction) {
-                if (mDialog != null) {
-                    // Usually clicking an item shuts down the phone, locks, or starts an activity.
-                    // We don't want to animate back into the power button when that happens, so we
-                    // disable the dialog animation before dismissing.
-                    mDialogLaunchAnimator.disableAllCurrentDialogsExitAnimations();
-                    mDialog.dismiss();
-                } else {
-                    Log.w(TAG, "Action long-clicked while mDialog is null.");
-                }
-                return ((LongPressAction) action).onLongPress();
-            }
+        @Override
+        public void onClickItem(int position) {
+            getItem(position).onPress();
+        }
+
+        public boolean onLongClickItem(int position) {
             return false;
         }
 
-        private void onClickItem(int position) {
-            Action item = getItem(position);
-            if (!(item instanceof SilentModeTriStateAction)) {
-                if (mDialog != null) {
-                    // Usually clicking an item shuts down the phone, locks, or starts an activity.
-                    // We don't want to animate back into the power button when that happens, so we
-                    // disable the dialog animation before dismissing.
-                    mDialogLaunchAnimator.disableAllCurrentDialogsExitAnimations();
-                    mDialog.dismiss();
-                } else {
-                    Log.w(TAG, "Action clicked while mDialog is null.");
-                }
-                item.onPress();
-            }
+        @Override
+        public boolean shouldBeSeparated(int position) {
+            return false;
         }
     }
 
@@ -1934,6 +1978,31 @@ public class GlobalActionsDialogLite implements DialogInterface.OnDismissListene
         }
     }
 
+    /**
+     * A toggle action knows whether it is on or off, and displays an icon
+     * and status message accordingly.
+     */
+    private abstract class AdvancedAction extends SinglePressAction {
+        protected AdvancedAction(int iconResid, int messageResid) {
+            super(iconResid, messageResid);
+        }
+
+        @Override
+        public boolean showDuringKeyguard() {
+            return true;
+        }
+
+        @Override
+        public boolean showBeforeProvisioning() {
+            return true;
+        }
+
+        @Override
+        public boolean shouldBeSeparated() {
+            return true;
+        }
+    }
+
     private class AirplaneModeAction extends ToggleAction {
         AirplaneModeAction() {
             super(
diff --git a/packages/SystemUI/src/com/android/systemui/globalactions/GlobalActionsImpl.java b/packages/SystemUI/src/com/android/systemui/globalactions/GlobalActionsImpl.java
index c5027cc511a4..e388881d8428 100644
--- a/packages/SystemUI/src/com/android/systemui/globalactions/GlobalActionsImpl.java
+++ b/packages/SystemUI/src/com/android/systemui/globalactions/GlobalActionsImpl.java
@@ -70,6 +70,7 @@ public class GlobalActionsImpl implements GlobalActions, CommandQueue.Callbacks
     public void showShutdownUi(boolean isReboot, String reason) {
         mShutdownUi.showShutdownUi(isReboot, reason);
     }
+
     @Override
     public void disable(int displayId, int state1, int state2, boolean animate) {
         final boolean disabled = (state2 & DISABLE2_GLOBAL_ACTIONS) != 0;
diff --git a/packages/SystemUI/src/com/android/systemui/globalactions/GlobalActionsPowerDialog.java b/packages/SystemUI/src/com/android/systemui/globalactions/GlobalActionsPowerDialog.java
index caa88a372036..cd832e90ffd0 100644
--- a/packages/SystemUI/src/com/android/systemui/globalactions/GlobalActionsPowerDialog.java
+++ b/packages/SystemUI/src/com/android/systemui/globalactions/GlobalActionsPowerDialog.java
@@ -15,16 +15,22 @@
  */
 package com.android.systemui.globalactions;
 
+import static android.view.ViewGroup.LayoutParams.WRAP_CONTENT;
+
 import android.annotation.NonNull;
 import android.app.Dialog;
 import android.content.Context;
-import android.content.res.Resources;
 import android.view.LayoutInflater;
 import android.view.View;
 import android.view.ViewGroup;
 import android.view.Window;
-import android.view.WindowManager;
-import android.widget.ListAdapter;
+import android.view.WindowInsets;
+import android.view.WindowManager.LayoutParams;
+import android.widget.LinearLayout;
+
+import com.android.systemui.MultiListLayout;
+import com.android.systemui.MultiListLayout.MultiListAdapter;
+import com.android.systemui.R;
 
 /**
  * Creates a customized Dialog for displaying the Shut Down and Restart actions.
@@ -34,28 +40,56 @@ public class GlobalActionsPowerDialog {
     /**
      * Create a dialog for displaying Shut Down and Restart actions.
      */
-    public static Dialog create(@NonNull Context context, ListAdapter adapter) {
-        ViewGroup listView = (ViewGroup) LayoutInflater.from(context).inflate(
-                com.android.systemui.R.layout.global_actions_power_dialog, null);
+    public static Dialog create(@NonNull Context context, MultiListAdapter adapter) {
+        final ViewGroup view = (ViewGroup) LayoutInflater.from(context).inflate(
+                R.layout.global_actions_grid_lite, null);
+
+        final MultiListLayout multiListLayout = view.findViewById(R.id.global_actions_view);
+        multiListLayout.setAdapter(adapter);
 
-        for (int i = 0; i < adapter.getCount(); i++) {
-            View action = adapter.getView(i, null, listView);
-            listView.addView(action);
+        final View overflowButton = view.findViewById(R.id.global_actions_overflow_button);
+        if (overflowButton != null) {
+            overflowButton.setVisibility(View.GONE);
+            final LinearLayout.LayoutParams params =
+                (LinearLayout.LayoutParams) multiListLayout.getLayoutParams();
+            params.setMarginEnd(context.getResources().getDimensionPixelSize(
+                    R.dimen.global_actions_side_margin));
+            multiListLayout.setLayoutParams(params);
         }
 
-        Resources res = context.getResources();
+        final Dialog dialog = new Dialog(context) {
+            @Override
+            protected void onStart() {
+                super.onStart();
+                multiListLayout.updateList();
+            }
 
-        Dialog dialog = new Dialog(context);
-        dialog.requestWindowFeature(Window.FEATURE_NO_TITLE);
-        dialog.setContentView(listView);
+            @Override
+            public void show() {
+                super.show();
+                view.setOnApplyWindowInsetsListener((v, windowInsets) -> {
+                    view.setPadding(
+                        windowInsets.getStableInsetLeft(),
+                        windowInsets.getStableInsetTop(),
+                        windowInsets.getStableInsetRight(),
+                        windowInsets.getStableInsetBottom()
+                    );
+                    return WindowInsets.CONSUMED;
+                });
+            }
+        };
 
-        Window window = dialog.getWindow();
-        window.setType(WindowManager.LayoutParams.TYPE_VOLUME_OVERLAY);
-        window.setTitle(""); // prevent Talkback from speaking first item name twice
-        window.setBackgroundDrawable(res.getDrawable(
-                com.android.systemui.R.drawable.control_background, context.getTheme()));
-        window.addFlags(WindowManager.LayoutParams.FLAG_ALT_FOCUSABLE_IM);
+        final Window window = dialog.getWindow();
+        window.setLayout(WRAP_CONTENT, WRAP_CONTENT);
+        window.setType(LayoutParams.TYPE_VOLUME_OVERLAY);
+        window.addFlags(
+            LayoutParams.FLAG_ALT_FOCUSABLE_IM |
+            LayoutParams.FLAG_SHOW_WHEN_LOCKED |
+            LayoutParams.FLAG_HARDWARE_ACCELERATED
+        );
 
+        dialog.requestWindowFeature(Window.FEATURE_NO_TITLE);
+        dialog.setContentView(view);
         return dialog;
     }
-}
+}
\ No newline at end of file
diff --git a/packages/SystemUI/src/com/android/systemui/globalactions/ShutdownUi.java b/packages/SystemUI/src/com/android/systemui/globalactions/ShutdownUi.java
index 68dc1b3dc7d7..fff754c52fdb 100644
--- a/packages/SystemUI/src/com/android/systemui/globalactions/ShutdownUi.java
+++ b/packages/SystemUI/src/com/android/systemui/globalactions/ShutdownUi.java
@@ -143,9 +143,11 @@ public class ShutdownUi {
         if (reason != null && reason.startsWith(PowerManager.REBOOT_RECOVERY_UPDATE)) {
             return R.string.reboot_to_update_reboot;
         } else if (reason != null && reason.equals(PowerManager.REBOOT_RECOVERY)) {
-            return R.string.reboot_to_reset_message;
+            return R.string.reboot_to_recovery_message;
+        } else if (reason != null && reason.equals(PowerManager.REBOOT_BOOTLOADER)) {
+            return R.string.reboot_to_bootloader_message;
         } else if (isReboot) {
-            return R.string.reboot_to_reset_message;
+            return R.string.reboot_message;
         } else {
             return R.string.shutdown_progress;
         }
@@ -155,8 +157,6 @@ public class ShutdownUi {
     @VisibleForTesting String getReasonMessage(@Nullable String reason) {
         if (reason != null && reason.startsWith(PowerManager.REBOOT_RECOVERY_UPDATE)) {
             return mContext.getString(R.string.reboot_to_update_title);
-        } else if (reason != null && reason.equals(PowerManager.REBOOT_RECOVERY)) {
-            return mContext.getString(R.string.reboot_to_reset_title);
         } else {
             return null;
         }
diff --git a/services/core/java/com/android/server/power/ShutdownThread.java b/services/core/java/com/android/server/power/ShutdownThread.java
index 5666c3388f0d..9098e8be7781 100644
--- a/services/core/java/com/android/server/power/ShutdownThread.java
+++ b/services/core/java/com/android/server/power/ShutdownThread.java
@@ -329,22 +329,37 @@ public final class ShutdownThread extends Thread {
                             com.android.internal.R.string.reboot_to_update_reboot));
             }
         } else if (mReason != null && mReason.equals(PowerManager.REBOOT_RECOVERY)) {
-            if (RescueParty.isAttemptingFactoryReset()) {
+            if (showSysuiReboot()) {
+                return null;
+            } else if (RescueParty.isAttemptingFactoryReset()) {
                 // We're not actually doing a factory reset yet; we're rebooting
                 // to ask the user if they'd like to reset, so give them a less
                 // scary dialog message.
                 pd.setTitle(context.getText(com.android.internal.R.string.power_off));
                 pd.setMessage(context.getText(com.android.internal.R.string.shutdown_progress));
                 pd.setIndeterminate(true);
-            } else if (showSysuiReboot()) {
-                return null;
             } else {
                 // Factory reset path. Set the dialog message accordingly.
-                pd.setTitle(context.getText(com.android.internal.R.string.reboot_to_reset_title));
+                pd.setTitle(context.getText(com.android.internal.R.string.reboot_to_recovery_title));
                 pd.setMessage(context.getText(
-                            com.android.internal.R.string.reboot_to_reset_message));
+                            com.android.internal.R.string.reboot_to_recovery_message));
                 pd.setIndeterminate(true);
             }
+        } else if (mReason != null && mReason.equals(PowerManager.REBOOT_BOOTLOADER)) {
+            if (showSysuiReboot()) {
+                return null;
+            }
+            pd.setTitle(context.getText(com.android.internal.R.string.reboot_to_bootloader_title));
+            pd.setMessage(context.getText(
+                        com.android.internal.R.string.reboot_to_bootloader_message));
+            pd.setIndeterminate(true);
+        } else if (mReboot) {
+             if (showSysuiReboot()) {
+                  return null;
+             }
+            pd.setTitle(context.getText(com.android.internal.R.string.reboot_title));
+            pd.setMessage(context.getText(com.android.internal.R.string.reboot_message));
+            pd.setIndeterminate(true);
         } else {
             if (showSysuiReboot()) {
                 return null;
diff --git a/services/core/java/com/android/server/statusbar/StatusBarManagerService.java b/services/core/java/com/android/server/statusbar/StatusBarManagerService.java
index 5183e0cd081e..22789433113b 100644
--- a/services/core/java/com/android/server/statusbar/StatusBarManagerService.java
+++ b/services/core/java/com/android/server/statusbar/StatusBarManagerService.java
@@ -1639,6 +1639,24 @@ public class StatusBarManagerService extends IStatusBarService.Stub implements D
         }
     }
 
+    /**
+     * Allows the status bar to reboot the device to recovery or bootloader.
+     */
+    @Override
+    public void advancedReboot(String mode) {
+        enforceStatusBarService();
+        long identity = Binder.clearCallingIdentity();
+        try {
+            mHandler.post(() -> {
+                // ShutdownThread displays UI, so give it a UI context.
+                    ShutdownThread.reboot(getUiContext(),
+                            mode, false/*don't ask for confirmation*/);
+            });
+        } finally {
+            Binder.restoreCallingIdentity(identity);
+        }
+    }
+
     @Override
     public void onGlobalActionsShown() {
         enforceStatusBarService();
-- 
2.45.2

